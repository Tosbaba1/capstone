<div class="text-center my-3">
  <%= link_to 'Following', posts_path, class: "mx-3 #{params[:tab] == 'explore' ? '' : 'fw-bold'}" %>
  <%= link_to 'Explore', posts_path(tab: 'explore'), class: "mx-3 #{params[:tab] == 'explore' ? 'fw-bold' : ''}" %>
</div>

<%= form_with url: insert_post_path, scope: :post, local: true, html: {class: "mb-3"}, data: {controller: "post-form"} do |f| %>
  <%= f.hidden_field :creator_id, value: current_user.id %>

  <div class="mb-3">
    <%= f.text_area :content,
          rows: 3,
          placeholder: "What's happening?",
          class: "form-control" %>
  </div>

  <div class="mb-3">
    <%= f.collection_select :book_id,
          Book.all, :id, :title,
          prompt: "‚Äî no book ‚Äî",
          class: "form-select" %>
  </div>

  <div class="post-icons mb-2">
    <span data-action="post-form#attachMedia">üñºÔ∏è</span>
    <span data-action="post-form#attachVideo">üé•</span>
    <span data-action="post-form#togglePoll">üìä</span>
  </div>

  <%= f.file_field :media, multiple: true, direct_upload: true, class: "d-none", data: {post_form_target: "mediaInput"} %>

  <div id="poll-fields" class="d-none" data-post-form-target="poll">
    <%= text_field_tag :poll_question, nil, placeholder: "Poll question", class: "form-control mb-2" %>
    <%= text_field_tag :poll_option1, nil, placeholder: "Option 1", class: "form-control mb-2" %>
    <%= text_field_tag :poll_option2, nil, placeholder: "Option 2", class: "form-control mb-2" %>
    <%= text_field_tag :poll_option3, nil, placeholder: "Option 3 (optional)", class: "form-control mb-2" %>
    <%= text_field_tag :poll_option4, nil, placeholder: "Option 4 (optional)", class: "form-control mb-2" %>
  </div>

  <div class="mb-3">
    <%= f.submit "Post", class: "btn btn-primary" %>
  </div>
<% end %>

<hr>

<div class="posts-feed">
  <% @list_of_posts.each do |post| %>
    <div class="post-card">
      <div class="post-header">
        <%= image_tag(post.creator.avatar || 'default_avatar.png', alt: post.creator.name, class: 'avatar') %>
        <div class="post-user-info">
          <strong><%= post.creator.name %></strong>
        </div>
      </div>
      <span class="post-body">
        <p><%= post.content %></p>
        <% if post.book %>
          <p class="post-book">
            Reading: <%= link_to post.book.title, book_path(post.book) %>
          </p>
        <% end %>
        <% if post.poll_data.present? %>
          <div class="mt-2">
            <p><strong><%= post.poll_data['question'] %></strong></p>
            <ul>
              <% post.poll_data.except('question').each_value do |option| %>
                <li><%= option %></li>
              <% end %>
            </ul>
          </div>
        <% end %>
      </span>
        <div class="post-footer mb-2">
          <span class="me-3"><%= pluralize(post.likes_count, 'Like') %></span>
          <span class="me-3"><%= pluralize(post.comments_count, 'Comment') %></span>
          <span><%= time_ago_in_words(post.created_at) %> ago</span>
        </div>

        <% like = post.likes.find_by(liked: current_user) %>
        <% if like %>
          <%= link_to 'Unlike', "/delete_like/#{like.id}", class: 'btn btn-sm btn-link p-0' %>
        <% else %>
          <%= link_to 'Like', insert_like_path(query_post_id: post.id, query_liked_id: current_user.id), class: 'btn btn-sm btn-link p-0' %>
        <% end %>

        <%= form_with url: insert_comment_path, scope: :comment, local: true, class: 'mt-2' do |cf| %>
          <%= cf.hidden_field :post_id, value: post.id %>
          <%= cf.hidden_field :commenter_id, value: current_user.id %>
          <div class="input-group input-group-sm">
            <%= cf.text_field :comment, class: 'form-control', placeholder: 'Add a comment' %>
            <button class="btn btn-outline-secondary">Comment</button>
          </div>
        <% end %>

        <% post.comments.each do |comment| %>
          <div class="mt-2 ps-2 border-start">
            <strong><%= comment.commenter.name %></strong> <%= comment.comment %>
          </div>
        <% end %>
      </div>
      <hr>
    <% end %>
  </div>
